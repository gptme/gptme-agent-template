name: Validate Workspace

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Validate workspace structure
      run: |
        # Use the workspace validator from gptme-contrib
        python3 gptme-contrib/scripts/workspace_validator/validate.py

  fork-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install uv
      uses: astral-sh/setup-uv@v4

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip

    - name: Setup git
      run: |
        git config --global user.email "test@example.com"
        git config --global user.name "Test User"

    - name: Test fork.sh creates valid workspace
      run: |
        # Run fork script
        ./scripts/fork.sh /tmp/test-agent test-agent

        # Validate the forked workspace using gptme-contrib validator
        cd /tmp/test-agent
        python3 gptme-contrib/scripts/workspace_validator/validate.py

        # Additional fork-specific checks
        echo "=== Fork-specific validation ==="

        # Check agent name was updated
        if grep -q "test-agent" gptme.toml; then
          echo "✅ Agent name updated in gptme.toml"
        else
          echo "❌ Agent name not found in gptme.toml"
          exit 1
        fi

        # Check it's a valid git repository
        if git status > /dev/null 2>&1; then
          echo "✅ Fork is a valid git repository"
        else
          echo "❌ Fork is not a valid git repository"
          exit 1
        fi

        # Regression test: verify no "gptme-agent" references remain
        # (except in .git/ and gptme-contrib/ submodule which are not user-facing)
        # Regression test for template string replacement
        LEAKS=$(grep -r "gptme-agent" --include="*.md" --include="*.toml" --include="*.yaml" --include="*.yml" --include="*.sh" . \
          --exclude-dir=.git --exclude-dir=gptme-contrib 2>/dev/null || true)
        if [ -n "$LEAKS" ]; then
          echo "❌ Found unreplaced 'gptme-agent' references in forked workspace:"
          echo "$LEAKS"
          exit 1
        else
          echo "✅ No 'gptme-agent' references leaked into forked workspace"
        fi

        echo "=== All fork tests passed ==="
