name: Integration Tests

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  workspace-validation:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pyyaml

    - name: Validate workspace structure
      run: |
        echo "=== Validating required files exist ==="
        for file in gptme.toml ABOUT.md ARCHITECTURE.md TASKS.md README.md; do
          if [ -f "$file" ]; then
            echo "✅ $file exists"
          else
            echo "❌ $file missing"
            exit 1
          fi
        done
        echo "=== Validating required directories ==="
        for dir in journal knowledge lessons people tasks; do
          if [ -d "$dir" ]; then
            echo "✅ $dir/ exists"
          else
            echo "❌ $dir/ missing"
            exit 1
          fi
        done

    - name: Validate gptme.toml configuration
      run: |
        python3 << 'PYEOF'
        import tomllib
        import os

        with open('gptme.toml', 'rb') as f:
            config = tomllib.load(f)

        # Check agent section exists
        assert 'agent' in config, 'Missing [agent] section'
        print('✅ [agent] section present')

        # Check prompt.files if present
        if 'prompt' in config and 'files' in config['prompt']:
            for f in config['prompt']['files']:
                # Skip gptme-contrib files since submodule may not be initialized
                if f.startswith('gptme-contrib/'):
                    print(f'⏭️  Skipping submodule file: {f}')
                    continue
                if os.path.exists(f):
                    print(f'✅ Referenced file exists: {f}')
                else:
                    print(f'❌ Missing referenced file: {f}')
                    exit(1)
        PYEOF

  git-hooks:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install test dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest

    - name: Setup git for tests
      run: |
        git config --global user.email "test@example.com"
        git config --global user.name "Test User"

    - name: Run git hooks integration tests
      run: |
        cd gptme-contrib
        if [ -f tests/integration/test_git_hooks.py ]; then
          pytest tests/integration/test_git_hooks.py -v
        else
          echo "⚠️ Git hooks integration tests not found, skipping"
        fi

  fork-validation:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip uv
        pip install pre-commit

    - name: Setup git
      run: |
        git config --global user.email "test@example.com"
        git config --global user.name "Test User"

    - name: Test fork.sh with validation
      run: |
        ./fork.sh /tmp/test-agent test-agent
        echo "=== Validating forked workspace ==="
        cd /tmp/test-agent
        for file in gptme.toml ABOUT.md ARCHITECTURE.md; do
          if [ -f "$file" ]; then
            echo "✅ $file exists in fork"
          else
            echo "❌ $file missing in fork"
            exit 1
          fi
        done
        if grep -q "test-agent" gptme.toml; then
          echo "✅ Agent name updated in gptme.toml"
        else
          echo "❌ Agent name not found in gptme.toml"
          exit 1
        fi
        if git status > /dev/null 2>&1; then
          echo "✅ Fork is a valid git repository"
        else
          echo "❌ Fork is not a valid git repository"
          exit 1
        fi

  container-setup:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Build and run test container
      run: |
        cat > /tmp/Dockerfile.test << 'DOCKERFILE'
        FROM ubuntu:24.04
        RUN apt-get update && apt-get install -y python3 python3-pip git && rm -rf /var/lib/apt/lists/*
        RUN useradd -m -s /bin/bash testuser
        COPY --chown=testuser:testuser . /home/testuser/agent
        USER testuser
        WORKDIR /home/testuser/agent
        DOCKERFILE

        docker build -t agent-test -f /tmp/Dockerfile.test .

        docker run --rm agent-test bash -c '
          echo "=== Testing agent setup in container ==="
          for f in gptme.toml ABOUT.md ARCHITECTURE.md; do
            test -f "$f" && echo "✅ $f" || (echo "❌ $f" && exit 1)
          done
          if [ -d dotfiles ]; then echo "✅ dotfiles directory present"; fi
          if [ -d systemd ]; then echo "✅ systemd directory present"; fi
          echo "=== All container tests passed ==="
        '
